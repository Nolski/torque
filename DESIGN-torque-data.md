# torque-data

This is a preliminary design document that will be merged into DESIGN.md when
the first version has been completed.  At a very high level, torque-data is
a lightweight CMS designed to meet the authorization and display needs for
the macfound project.

## torqueData Flask app

The flask app, named `torqueData` exists to use a backing store, initially
csvs generated from the macfound repository, and provide different outputs
necessary for the project.

It provides the following features.

### Input from CSV

Initially the data store is a csv, but `torqueData` will do more than just
front a csv file.  Currently macfound collects metadata regarding things
like Categories and inserts that directly into the generated pages, then
the wiki parses those pages to create the links.  This metadata will be
retained in `torqueData` in order to create custom outputs as needed.

### Wiki Markup from CSV rows

Previously handled by csv2wiki and the section map in the macfound repository,
torqueData will handle the generation of wiki pages.  This will be changed
from section maps to templates, though that may not happen initially.

Fully rendered wiki pages are provided, for two reasons.

Practically, the rendering of pages is handled by csv2wiki, and that's written
in python already, with the later jinja templating also second nature to python
webapps.  Additionally, mediawiki is not a particularly good CMS, nor is it a
very good templating engine, and it's easier to write this in python than php.

Philosophically, `torqueData` aims to be more than just a simple passthrough
for a datastore, and placing view/rendering concerns here allows the path
to that future to be traversed more easily.  For instance, output to latex
for pdf creation (in the case that the current book creation approach fails to
meet approval) would most easily be handled if the full rendering pipeline
already exists.

### MediaWiki TOC

Because the Table Of Contents of all proposals should be different depending
on what a user is authorized to see, it needs to be generated by the CMS.

### MediaWiki Category Pages

Because Category Pages in mediawiki do not filter based on authorization,
and so `torqueData` will create the category pages.  This will allow more
customization of what goes on the category page, as currently they are
contextless.  For instance, categorizing by country is a binary switch,
even though current proposals have context (country of origin, vs country
of research).

### JSON/XML/??? output from CSV rows for API

As yet undeveloped, it is likely that an API will be required by outside
sources, and this would render the data as needed.

### Attachments

One large issue with mediawiki is that there's no way to strongly associate
attachments (in this case, pdfs) with pages, and then have authorization
fall through to those.  Indeed, the default setting is that attachments
are just handled by the filesystem and webserver.  `torqueData` will handle
those attachments, and all the authorizations therein.

### Search results

Because mediawiki cannot cull search results based on authorization,
since it's not a CMS, that will be handled by `torqueData`.  Those
search results will most likely come back as json, so that someone
using the api can use them.

The search will start as a very plain exact text search, but can be
upgraded to use any search libraries as needed.

### Authorization Posting

`torqueData` will be provide an endpoint that someone can tell it what
users are authorized to see what backing store data.  It will then store
this data in its own database.

## TorqueDataConnect MediaWiki Extension

This extension is a first pass at giving an output for wiki pages generated
by `torqueData` directly in mediawiki.  The likely method for embedding this
in a page will be by inclusino of a simple tag `<TorqueDataConnect />` with
arguments about which page to get.  Most likely will translate into a call
such as `http://localhost:3000/data/<proposalNumber>.mwiki` that is just
passed out to the mediawiki renderer.

This will also provide the ability to query for category and ToC pages.

Potential risk is that there is a page created for every proposal, so that
list is available in some form in mediawiki.  One way to counteract that
would be to include a page for all proposals, regardless of status.  Then
the table of contents would be generated for available proposals.

### ExternalData MediaWiki extension

The https://www.mediawiki.org/wiki/Extension:External_Data extension may
fit the needs above and more, and should be evaluated.

## TorqueDataSearch MediaWiki Extension

This would hook into MediaWiki's search and add results to their page.
No idea how to do this yet, but it needs to be done.

## TorqueDataAuthorize MediaWiki Extension

This would allow users to define the authorization types for groups,
or users, and what proposals they can see.  When editing this list,
in a mediawiki page, it will then propogate to `torqueData` to be
stored for authorization purposes.

There is a potential issue if edits are done, and `torqueData` isn't
currently running.  This should be handled by either an error output,
or retry logic.
